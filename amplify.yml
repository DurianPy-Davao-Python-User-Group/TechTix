version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - npm ci --cache .npm --prefer-offline
            - |
              if [ "$AWS_BRANCH" = "main" ]; then
                  STAGE=dev
              elif [ "$AWS_BRANCH" = "stage" ]; then
                  STAGE=staging
              elif [ "$AWS_BRANCH" = "prod" ]; then
                  STAGE=prod
              else
                  STAGE=dev
              fi
              echo "Using STAGE=$STAGE (branch=$AWS_BRANCH, region=$AWS_REGION)"

              npm run generate:outputs "$STAGE" --region "$AWS_REGION"
              npm run generate:env "$STAGE" --region "$AWS_REGION"
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: dist
        files:
          - "**/*"
      cache:
        paths:
          - ".npm/**/*"
          - node_modules/**/*
    appRoot: frontend
